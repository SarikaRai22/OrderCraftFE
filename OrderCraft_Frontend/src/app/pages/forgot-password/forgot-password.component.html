<div class="forgot-password-container">
  <div class="card">
    <div class="card-header">
      <h2>Reset Password</h2>
    </div>
    
    <div class="card-body">
      <!-- Step 1: Email Input -->
      <div *ngIf="step === 1" class="step-container">
        <p>Enter your email address to receive a password reset OTP</p>
        
        <form [formGroup]="forgotForm" (ngSubmit)="requestOtp()">
          <div class="form-group">
            <label for="email">Email Address</label>
            <input 
              type="email" 
              id="email" 
              formControlName="email" 
              class="form-control" 
              placeholder="Enter your email"
              [ngClass]="{ 'is-invalid': f['email'].touched && f['email'].errors }"
            />
            <div *ngIf="f['email'].touched && f['email'].errors" class="invalid-feedback">
              <div *ngIf="f['email'].errors?.['required']"><br>Email is required</div>
              <div *ngIf="f['email'].errors?.['email']"><br>Please enter a valid email</div>
            </div>
          </div>
          
          <button type="submit" class="btn btn-primary btn-block" [disabled]="isLoading">
            <span *ngIf="isLoading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            {{ isLoading ? 'Sending...' : 'Request OTP' }}
          </button>
        </form>
      </div>

      <!-- Step 2: OTP Verification -->
      <div *ngIf="step === 2" class="step-container">
        <p>We've sent a 6-digit OTP to your email. Please enter it below.</p>
        
        <form [formGroup]="verifyForm" (ngSubmit)="verifyOtp()">
          <div class="form-group">
            <label for="otp">OTP Code</label>
            <input 
              type="text" 
              id="otp" 
              formControlName="otp" 
              class="form-control" 
              placeholder="Enter 6-digit OTP"
              maxlength="6"
              [ngClass]="{ 'is-invalid': v['otp'].touched && v['otp'].errors }"
            />
            <div *ngIf="v['otp'].touched && v['otp'].errors" class="invalid-feedback">
              <div *ngIf="v['otp'].errors?.['required']">OTP is required</div>
              <div *ngIf="v['otp'].errors?.['minlength'] || v['otp'].errors?.['maxlength']">
                OTP must be 6 digits
              </div>
            </div>
          </div>
          
          <button type="submit" class="btn btn-primary btn-block" [disabled]="isLoading">
            <span *ngIf="isLoading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            {{ isLoading ? 'Verifying...' : 'Verify OTP' }}
          </button>
        </form>
      </div>

      <!-- Step 3: Password Reset -->
      <div *ngIf="step === 3" class="step-container">
        <p>Please enter your new password</p>
        
        <form [formGroup]="resetForm" (ngSubmit)="resetPassword()">
          <div class="form-group">
            <label for="newPassword">New Password</label>
            <input 
              type="password" 
              id="newPassword" 
              formControlName="newPassword" 
              class="form-control" 
              placeholder="New password (min 8 characters)"
              [ngClass]="{ 'is-invalid': r['newPassword'].touched && r['newPassword'].errors }"
            />
            <div *ngIf="r['newPassword'].touched && r['newPassword'].errors" class="invalid-feedback">
              <div *ngIf="r['newPassword'].errors?.['required']">Password is required</div>
              <div *ngIf="r['newPassword'].errors?.['minlength']">
                Password must be at least 8 characters
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="confirmPassword">Confirm Password</label>
            <input 
              type="password" 
              id="confirmPassword" 
              formControlName="confirmPassword" 
              class="form-control" 
              placeholder="Confirm your password"
              [ngClass]="{ 'is-invalid': r['confirmPassword'].touched && (r['confirmPassword'].errors || resetForm.errors?.['mismatch']) }"
            />
            <div *ngIf="r['confirmPassword'].touched && (r['confirmPassword'].errors || resetForm.errors?.['mismatch'])" class="invalid-feedback">
              <div *ngIf="r['confirmPassword'].errors?.['required']">Please confirm your password</div>
              <div *ngIf="resetForm.errors?.['mismatch']">Passwords do not match</div>
            </div>
          </div>
          
          <button type="submit" class="btn btn-success btn-block" [disabled]="isLoading">
            <span *ngIf="isLoading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            {{ isLoading ? 'Resetting...' : 'Reset Password' }}
          </button>
        </form>
      </div>

      <!-- Step 4: Success Message -->
      <div *ngIf="step === 4" class="step-container text-center">
        <div class="success-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="#28a745" viewBox="0 0 16 16" align="center">
            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
          </svg>
        </div>
        <h3>Password Reset Successful!</h3>
        <p>Your password has been successfully reset. You can now login with your new password.</p>
        <button class="btn btn-primary" (click)="goToLogin()">Back to Login</button>
      </div>

      <!-- Status Message -->
      <div *ngIf="message" class="alert alert-{{messageType}} mt-3">
        {{ message }}
      </div>
    </div>
    
    <div class="card-footer text-center">
      <button *ngIf="step < 4" class="btn btn-primary" (click)="goToLogin()">Back to Login</button>
    </div>
  </div>
</div>